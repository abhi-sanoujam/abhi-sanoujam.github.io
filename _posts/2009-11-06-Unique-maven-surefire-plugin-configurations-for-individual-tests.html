---           
layout: post
title: Unique maven surefire plugin configurations for individual tests
date: 2009-11-06 13:06:39 UTC
updated: 2009-11-06 13:06:39 UTC
comments: false
categories: integration-test maven system-test test
---
 
<script type="text/javascript">var dzone_style = '1';var dzone_url = 'http://abhisanoujam.blogspot.com/2009/11/unique-maven-surefire-plugin.html';</script> <script language="javascript" src="http://widgets.dzone.com/widgets/zoneit.js"></script><br /><br /><br />Here's what I want to do:<br /><br />I have a maven project, which has got multiple unit-tests, db-tests (e.g. DAO tests) and integration/system tests. One of the unit tests require high memory (e.g. 512 MB), but other unit tests runs fine with the default heap size (and doesn't need large heap).<br />I want to run all unit tests by default in the test phase of the build cycle, run the db-tests only when I know a db is present and run the system tests in the integration phase of the build cycle.<br /><br />Lets assume some names for the tests:<br /><br />1) Names of all unit tests end with Test.java, e.g. ClientTest.java, SomeLogicTest.java etc<br />2) The name of the unit test that require high-memory is TestTheWorldWithBigMemoryTest.java. Note that this is not a system tests, its a unit test and just that it requires large heap to run.<br />3) All db-tests end with DaoTest.java, e.g. UserDaoTest.java, CatalogDaoTest.java etc<br />4) All system/integration tests end with SystemTest.java, e.g. AddToShoppingCartSystemTest.java, PurchaseSystemTest.java etc<br /><br />OK, so here's how to configure your pom to do it:<br /><br /><pre name="code" class="xml:collapse"><br /><br />&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;<br />  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br />  &lt;groupId&gt;example&lt;/groupId&gt;<br />  &lt;artifactId&gt;MySampleProject&lt;/artifactId&gt;<br />  &lt;packaging&gt;jar&lt;/packaging&gt;<br />  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;<br />  &lt;name&gt;MySampleProject&lt;/name&gt;<br />  &lt;url&gt;http://www.abhisanoujam.blogspot.com/&lt;/url&gt;<br />  &lt;dependencies&gt;<br />    &lt;dependency&gt;<br />      &lt;groupId&gt;junit&lt;/groupId&gt;<br />      &lt;artifactId&gt;junit&lt;/artifactId&gt;<br />      &lt;version&gt;3.8.1&lt;/version&gt;<br />      &lt;scope&gt;test&lt;/scope&gt;<br />    &lt;/dependency&gt;<br />  &lt;/dependencies&gt;<br /><br />  &lt;build&gt;<br />    &lt;plugins&gt;<br /><br />      &lt;plugin&gt;<br />        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />        &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;<br />        &lt;inherited&gt;true&lt;/inherited&gt;<br />        &lt;configuration&gt;<br />          &lt;!--<br />            Skip tests by default. Will be using different executions<br />            setup to run different set of tests with different<br />            configurations<br />          --&gt;<br />          &lt;skip&gt;true&lt;/skip&gt;<br />          &lt;!-- other default configuration for all the tests, just an example --&gt;<br />          &lt;reportFormat&gt;plain&lt;/reportFormat&gt;<br />          &lt;systemProperties&gt;<br />            &lt;property&gt;<br />              &lt;name&gt;some.property.used.by.tests&lt;/name&gt;<br />              &lt;value&gt;what.you.want.value&lt;/value&gt;<br />            &lt;/property&gt;<br />          &lt;/systemProperties&gt;<br />        &lt;/configuration&gt;<br />        &lt;executions&gt;<br />          &lt;execution&gt;<br />            &lt;!-- run all tests except for system tests and the big memory test --&gt;<br />            &lt;id&gt;test-phase-execution&lt;/id&gt;<br />            &lt;phase&gt;test&lt;/phase&gt;<br />            &lt;goals&gt;<br />              &lt;goal&gt;test&lt;/goal&gt;<br />            &lt;/goals&gt;<br />            &lt;configuration&gt;<br />              &lt;skip&gt;false&lt;/skip&gt;<br />              &lt;includes&gt;<br />                &lt;include&gt;**/*Test.java&lt;/include&gt;<br />              &lt;/includes&gt;<br />              &lt;excludes&gt;<br />                &lt;!-- exclude inner classes --&gt;<br />                &lt;exclude&gt;**/*$*&lt;/exclude&gt;<br />                &lt;!-- exclude the test that need large heap --&gt;<br />                &lt;exclude&gt;**/TestTheWorldWithBigMemoryTest.java&lt;/exclude&gt;<br />                &lt;!-- exclude the system-tests --&gt;<br />                &lt;exclude&gt;**/*SystemTest.java&lt;/exclude&gt;<br />                &lt;!-- exclude the db-tests --&gt;<br />                &lt;exclude&gt;**/*DaoTest.java&lt;/exclude&gt;<br />              &lt;/excludes&gt;<br />            &lt;/configuration&gt;<br />          &lt;/execution&gt;<br />          &lt;execution&gt;<br />            &lt;!-- Run tests with 512 MB heap --&gt;<br />            &lt;id&gt;large-heap-test-execution&lt;/id&gt;<br />            &lt;phase&gt;test&lt;/phase&gt;<br />            &lt;goals&gt;<br />              &lt;goal&gt;test&lt;/goal&gt;<br />            &lt;/goals&gt;<br />            &lt;configuration&gt;<br />              &lt;skip&gt;false&lt;/skip&gt;<br />              &lt;includes&gt;<br />                &lt;!--<br />                  You can even follow some pattern for these kind of<br />                  tests and use the pattern here<br />                --&gt;<br />                &lt;!-- For example, **/*BigMemoryTest.java --&gt;<br />                &lt;include&gt;**/TestTheWorldWithBigMemoryTest.java&lt;/include&gt;<br />              &lt;/includes&gt;<br />              &lt;excludes&gt;<br />                &lt;exclude&gt;**/*$*&lt;/exclude&gt;<br />              &lt;/excludes&gt;<br />              &lt;argLine&gt;-Xms512m -Xmx512m&lt;/argLine&gt;<br />            &lt;/configuration&gt;<br />          &lt;/execution&gt;<br />          &lt;execution&gt;<br />            &lt;!-- Run the system tests in the integration-phase --&gt;<br />            &lt;id&gt;system-tests-execution&lt;/id&gt;<br />            &lt;phase&gt;integration-test&lt;/phase&gt;<br />            &lt;goals&gt;<br />              &lt;goal&gt;test&lt;/goal&gt;<br />            &lt;/goals&gt;<br />            &lt;configuration&gt;<br />              &lt;skip&gt;false&lt;/skip&gt;<br />              &lt;includes&gt;<br />                &lt;include&gt;**/*SystemTest.java&lt;/include&gt;<br />              &lt;/includes&gt;<br />              &lt;excludes&gt;<br />                &lt;exclude&gt;**/*$*&lt;/exclude&gt;<br />              &lt;/excludes&gt;<br />            &lt;/configuration&gt;<br />          &lt;/execution&gt;<br />        &lt;/executions&gt;<br />      &lt;/plugin&gt;<br />    &lt;/plugins&gt;<br />  &lt;/build&gt;<br /><br />  &lt;profiles&gt;<br /><br />    &lt;!-- Profile for running database tests  --&gt;<br />    &lt;profile&gt;<br />      &lt;id&gt;test-db&lt;/id&gt;<br />      &lt;build&gt;<br />        &lt;plugins&gt;<br />          &lt;plugin&gt;<br />            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;<br />            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br />            &lt;configuration&gt;<br />              &lt;!--<br />                Skip tests as the other tests have been already executed<br />                in the "test" and "integration-test" phases<br />              --&gt;<br />              &lt;skip&gt;true&lt;/skip&gt;<br />            &lt;/configuration&gt;<br />            &lt;executions&gt;<br />              &lt;execution&gt;<br />                &lt;id&gt;db-test-execution&lt;/id&gt;<br />                &lt;phase&gt;test&lt;/phase&gt;<br />                &lt;goals&gt;<br />                  &lt;goal&gt;test&lt;/goal&gt;<br />                &lt;/goals&gt;<br />                &lt;configuration&gt;<br />                  &lt;skip&gt;false&lt;/skip&gt;<br />                  &lt;includes&gt;<br />                    &lt;!-- We only need to include the db tests here --&gt;<br />                    &lt;include&gt;**/*DaoTest.java&lt;/include&gt;<br />                  &lt;/includes&gt;<br />                &lt;/configuration&gt;<br />              &lt;/execution&gt;<br />            &lt;/executions&gt;<br />          &lt;/plugin&gt;<br />        &lt;/plugins&gt;<br />      &lt;/build&gt;<br />    &lt;/profile&gt;<br /><br />  &lt;/profiles&gt;<br /><br />&lt;/project&gt;<br /><br /><br /></pre><br /><br /><br />I'll try to explain in words (not xml ;-) ) what I did above:<br />By default, maven runs the "test" goal of maven surefire plugin. First we tell it to skip tests by adding the plugin in the &lt;build&gt; section of the pom and specifying &lt;skip&gt;true&lt;/skip&gt; in the main configuration of the plugin. Here, you can specify other configurations that you want for your tests as a whole.<br />Then we specify other executions for the plugin and play around with the include/exclude pattern and the configurations for each setup. We can setup multiple executions and also have different set of configurations for each execution setup. Just as a note, adding multiple &lt;plugin&gt; sections for the same plugin in the build section does not work, in fact this is the sole reason of this blog post, and to figure out how to have different configurations depending on your requirements for the same plugin.<br />In the "test-phase-execution", we include all tests with the <tt>**/*Test</tt> and exclude the big memory test, dao tests and the system tests.<br />For the unit-test that requires large heap, its just a matter of adding <tt>&lt;argLine&gt;-Xms512m -Xmx512m&lt;/argLine&gt;</tt> in the configuration for that execution setup. Also we include only that test to run in the include tag.<br />We bind another execution in the "integration-test" phase to run the system tests by matching the include pattern to only system tests.<br /><br />We add another profile "test-db", which we can use when we know we have a database is up and running (you don't want your dao tests to fail all the time during development when you don't have a DB running in your environment). In the profile, we again set up the maven-surefire plugin to execute only the dao tests by playing around with the include/exclude pattern. You can activate this profile whenever you want to run the dao tests.<br /><br />You can check-out a very simple project from <a href="http://abhi-sanoujam-blogspot-posts.googlecode.com/svn/trunk/mavenTestsPomSetup">here</a> and see the above pom in action.<br /><br />Here's how you would run them:<br /><br />mvn clean package<br /> -- This will run all the unit-tests (including the big memory test) but not the system tests and the dao tests<br /><br />mvn -Ptest-db clean package<br /> -- This will the all the unit tests (like above) and also run the dao tests. This still excludes the system test.<br /><br />mvn clean install<br /> -- This will run all the unit tests + the system tests. This won't run the dao tests.<br /> <br />mvn -Ptest-db clean install<br /> -- This will run all the tests -- unit tests, big memory test, dao tests and the system tests<br /> <br />Regarding the system/integration tests, instead of doing like above, you can separate all your system-tests in a separate sub-module too, which I guess is more appropriate when your project is kind of large.<br /><br />Enjoy...<img src="http://feeds.feedburner.com/~r/abhisanoujam-blogspot/~4/qPcst1Og4Sc" height="1" width="1"/>